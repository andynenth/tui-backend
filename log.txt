🔒 [Room 070A0B] Starting game: op_id=070A0B_1
🔍 DEBUG: Redeal limit check - multiplier: 1, limit: 2
🔧 DEBUG: Dealing weak hands to players at indices [0, 1] (max 9 points)
📊 DEBUG: Redeals so far: 0, Max allowed: 2
🔧 DEBUG: Found 24 weak pieces (≤9), 8 strong pieces (>9)
🔧 DEBUG: Andy (index 0) assigned weak hand
🔧 DEBUG: Bot 2 (index 1) assigned weak hand
🔧 DEBUG: Final hands verification:
  Andy: ['SOLDIER_BLACK(1)', 'HORSE_BLACK(5)', 'SOLDIER_BLACK(1)', 'HORSE_BLACK(5)', 'SOLDIER_BLACK(1)', 'CANNON_BLACK(3)', 'SOLDIER_RED(2)', 'CHARIOT_RED(8)']
    → Strong pieces (>9): 0
    → Has RED_GENERAL: False
    ⚠️ WARNING: Andy has NO strong pieces!
  Bot 2: ['ELEPHANT_BLACK(9)', 'ELEPHANT_BLACK(9)', 'CANNON_RED(4)', 'CANNON_RED(4)', 'CANNON_BLACK(3)', 'CHARIOT_BLACK(7)', 'CHARIOT_RED(8)', 'SOLDIER_RED(2)']
    → Strong pieces (>9): 0
    → Has RED_GENERAL: False
    ⚠️ WARNING: Bot 2 has NO strong pieces!
  Bot 3: ['ADVISOR_RED(12)', 'SOLDIER_RED(2)', 'CHARIOT_BLACK(7)', 'ELEPHANT_RED(10)', 'SOLDIER_BLACK(1)', 'SOLDIER_RED(2)', 'HORSE_RED(6)', 'HORSE_RED(6)']
    → Strong pieces (>9): 2
    → Has RED_GENERAL: False
  Bot 4: ['GENERAL_RED(14)', 'ADVISOR_RED(12)', 'ELEPHANT_RED(10)', 'SOLDIER_RED(2)', 'ADVISOR_BLACK(11)', 'SOLDIER_BLACK(1)', 'ADVISOR_BLACK(11)', 'GENERAL_BLACK(13)']
    → Strong pieces (>9): 6
    → Has RED_GENERAL: True
🔍 PREP_STATE_DEBUG: Play order: [Andy - 0 pts, Bot 2 - 0 pts, Bot 3 - 0 pts, Bot 4 - 0 pts]
🔍 PREP_STATE_DEBUG: Play order types: [<class 'engine.player.Player'>, <class 'engine.player.Player'>, <class 'engine.player.Player'>, <class 'engine.player.Player'>]
🎯 PREP_STATE_DEBUG: All weak players awaiting simultaneous decisions: {'Bot 2', 'Andy'}
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔄 PHASE_TRACKING_FIX: New phase detected None -> preparation
🚀 ENTERPRISE_BOT_DEBUG: _handle_enterprise_phase_change called - phase: preparation
🎲 REDEAL_PHASE_DEBUG: Handling redeal decisions - awaiting: ['Bot 2', 'Andy']
🤖 REDEAL_PHASE_DEBUG: Bot Bot 2 will decide in 1.3s...
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🤖 REDEAL_PHASE_DEBUG: Bot Bot 2 making redeal decision
🤖 Bot Bot 2 deciding: ACCEPT redeal
✅ Bot Bot 2 ACCEPTED redeal
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
✅ [Room 070A0B] Game and StateMachine started successfully: op_id=070A0B_1
✅ [Room 070A0B] Bot manager registered for 3 bots
✅ Game started in room 070A0B
🔍 REDEAL_DEBUG: Processing REDEAL_REQUEST as accept for Bot 2
🔍 REDEAL_DEBUG: _handle_redeal_decision - Bot 2 decision: accept=True
🔍 REDEAL_DEBUG: Recorded decision - redeal_decisions now: {'Bot 2': True}
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔍 PHASE_TRACKING_FIX: Same phase update: preparation
🚀 ENTERPRISE_BOT_DEBUG: _handle_enterprise_phase_change called - phase: preparation
🎲 REDEAL_PHASE_DEBUG: Handling redeal decisions - awaiting: ['Andy']
👤 REDEAL_PHASE_DEBUG: Player Andy is human, skipping
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
DEBUG_WS: Error sending to client in room 070A0B: 
DEBUG_WS_DISCONNECT: WebSocket client disconnected from room 070A0B.
INFO:     connection closed
DEBUG_WS: Unregistered connection for room 070A0B. Remaining connections: 0
DEBUG_WS: Room 070A0B has active game - keeping broadcast queue alive
INFO:     ('127.0.0.1', 56860) - "WebSocket /ws/070A0B" [accepted]
DEBUG_WS: Registered new connection for room 070A0B. Total connections: 1
INFO:     connection open
DEBUG_WS_RECEIVE: Received event 'client_ready' from client in room 070A0B with data: {'room_id': '070A0B'}
DEBUG_WS_RECEIVE: Sent current game phase preparation to client in room 070A0B
DEBUG_WS_RECEIVE: Sent initial room state to client in room 070A0B after client_ready.
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
DEBUG_WS_RECEIVE: Received event 'accept_redeal' from client in room 070A0B with data: {'player_name': 'Andy'}
✅ Redeal accept queued: Andy
🔍 REDEAL_DEBUG: Processing REDEAL_RESPONSE for Andy, accept=True
🔍 REDEAL_DEBUG: _handle_redeal_decision - Andy decision: accept=True
🔍 REDEAL_DEBUG: Recorded decision - redeal_decisions now: {'Bot 2': True, 'Andy': True}
🔍 REDEAL_DEBUG: _process_all_decisions - first_accepter: Andy, all decisions: {'Bot 2': True, 'Andy': True}
🔍 DEBUG: Redeal limit check - multiplier: 2, limit: 2
🔧 DEBUG: Dealing weak hands to players at indices [0, 1] (max 9 points)
📊 DEBUG: Redeals so far: 1, Max allowed: 2
🔧 DEBUG: Found 24 weak pieces (≤9), 8 strong pieces (>9)
🔧 DEBUG: Andy (index 0) assigned weak hand
🔧 DEBUG: Bot 2 (index 1) assigned weak hand
🔧 DEBUG: Final hands verification:
  Andy: ['CANNON_BLACK(3)', 'CHARIOT_RED(8)', 'SOLDIER_RED(2)', 'CANNON_RED(4)', 'CANNON_RED(4)', 'CHARIOT_BLACK(7)', 'CHARIOT_RED(8)', 'SOLDIER_RED(2)']
    → Strong pieces (>9): 0
    → Has RED_GENERAL: False
    ⚠️ WARNING: Andy has NO strong pieces!
  Bot 2: ['SOLDIER_BLACK(1)', 'SOLDIER_BLACK(1)', 'ELEPHANT_BLACK(9)', 'HORSE_RED(6)', 'HORSE_RED(6)', 'SOLDIER_BLACK(1)', 'SOLDIER_BLACK(1)', 'SOLDIER_BLACK(1)']
    → Strong pieces (>9): 0
    → Has RED_GENERAL: False
    ⚠️ WARNING: Bot 2 has NO strong pieces!
  Bot 3: ['ELEPHANT_RED(10)', 'HORSE_BLACK(5)', 'HORSE_BLACK(5)', 'ADVISOR_BLACK(11)', 'ADVISOR_RED(12)', 'SOLDIER_RED(2)', 'GENERAL_RED(14)', 'ELEPHANT_BLACK(9)']
    → Strong pieces (>9): 4
    → Has RED_GENERAL: True
  Bot 4: ['GENERAL_BLACK(13)', 'ELEPHANT_RED(10)', 'ADVISOR_BLACK(11)', 'SOLDIER_RED(2)', 'CANNON_BLACK(3)', 'CHARIOT_BLACK(7)', 'SOLDIER_RED(2)', 'ADVISOR_RED(12)']
    → Strong pieces (>9): 4
    → Has RED_GENERAL: False
🔍 PREP_STATE_DEBUG: Play order: [Andy - 0 pts, Bot 2 - 0 pts, Bot 3 - 0 pts, Bot 4 - 0 pts]
🔍 PREP_STATE_DEBUG: Play order types: [<class 'engine.player.Player'>, <class 'engine.player.Player'>, <class 'engine.player.Player'>, <class 'engine.player.Player'>]
🎯 PREP_STATE_DEBUG: All weak players awaiting simultaneous decisions: {'Bot 2', 'Andy'}
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔍 PHASE_TRACKING_FIX: Same phase update: preparation
🚀 ENTERPRISE_BOT_DEBUG: _handle_enterprise_phase_change called - phase: preparation
🎲 REDEAL_PHASE_DEBUG: Handling redeal decisions - awaiting: ['Bot 2', 'Andy']
🎲 REDEAL_PHASE_DEBUG: Player Bot 2 already decided
👤 REDEAL_PHASE_DEBUG: Player Andy is human, skipping
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
DEBUG_WS_RECEIVE: Received event 'accept_redeal' from client in room 070A0B with data: {'player_name': 'Andy'}
✅ Redeal accept queued: Andy
🔍 REDEAL_DEBUG: Processing REDEAL_RESPONSE for Andy, accept=True
🔍 REDEAL_DEBUG: _handle_redeal_decision - Andy decision: accept=True
🔍 REDEAL_DEBUG: Recorded decision - redeal_decisions now: {'Andy': True}
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔍 PHASE_TRACKING_FIX: Same phase update: preparation
🚀 ENTERPRISE_BOT_DEBUG: _handle_enterprise_phase_change called - phase: preparation
🎲 REDEAL_PHASE_DEBUG: Handling redeal decisions - awaiting: ['Bot 2']
🤖 REDEAL_PHASE_DEBUG: Bot Bot 2 will decide in 0.9s...
🤖 REDEAL_PHASE_DEBUG: Bot Bot 2 making redeal decision
🤖 Bot Bot 2 deciding: ACCEPT redeal
✅ Bot Bot 2 ACCEPTED redeal
🔍 PREP_STATE_DEBUG: Checking transition conditions...
   - Initial deal complete: True
   - Weak players: {'Bot 2', 'Andy'}
⏳ PREP_STATE_DEBUG: Have weak players - waiting for event-based transition
🔍 REDEAL_DEBUG: Processing REDEAL_REQUEST as accept for Bot 2
🔍 REDEAL_DEBUG: _handle_redeal_decision - Bot 2 decision: accept=True
🔍 REDEAL_DEBUG: Recorded decision - redeal_decisions now: {'Andy': True, 'Bot 2': True}
🔍 REDEAL_DEBUG: _process_all_decisions - first_accepter: Andy, all decisions: {'Andy': True, 'Bot 2': True}
🔍 DEBUG: Redeal limit check - multiplier: 3, limit: 2
🚫 DEBUG: Redeal limit (2) exceeded. Multiplier is 3 (>3)
🔄 DEBUG: Switching to guaranteed no redeal to prevent infinite loop.
🛡️ DEBUG: Dealing guaranteed no-redeal hands
🛡️ DEBUG: Available pieces - Strong: 7, Weak: 24
  → Andy gets strong piece: ADVISOR_BLACK(11)
  → Bot 2 gets strong piece: ELEPHANT_RED(10)
  → Bot 3 gets strong piece: ADVISOR_BLACK(11)
  → Bot 4 gets strong piece: ADVISOR_RED(12)
🛡️ DEBUG: Guaranteed no-redeal hands dealt:
🔧 DEBUG: Final hands verification:
  Andy: ['ELEPHANT_BLACK(9)', 'SOLDIER_RED(2)', 'ELEPHANT_RED(10)', 'CHARIOT_BLACK(7)', 'ADVISOR_BLACK(11)', 'CHARIOT_RED(8)', 'CHARIOT_BLACK(7)', 'HORSE_BLACK(5)']
    → Strong pieces (>9): 2
    → Has RED_GENERAL: False
  Bot 2: ['SOLDIER_RED(2)', 'ELEPHANT_BLACK(9)', 'SOLDIER_RED(2)', 'SOLDIER_BLACK(1)', 'CANNON_RED(4)', 'GENERAL_RED(14)', 'HORSE_RED(6)', 'ELEPHANT_RED(10)']
    → Strong pieces (>9): 2
    → Has RED_GENERAL: True
  Bot 3: ['ADVISOR_BLACK(11)', 'SOLDIER_BLACK(1)', 'SOLDIER_RED(2)', 'SOLDIER_BLACK(1)', 'SOLDIER_BLACK(1)', 'CANNON_BLACK(3)', 'GENERAL_BLACK(13)', 'CHARIOT_RED(8)']
    → Strong pieces (>9): 2
    → Has RED_GENERAL: False
  Bot 4: ['SOLDIER_BLACK(1)', 'HORSE_BLACK(5)', 'SOLDIER_RED(2)', 'ADVISOR_RED(12)', 'CANNON_RED(4)', 'HORSE_RED(6)', 'CANNON_BLACK(3)', 'ADVISOR_RED(12)']
    → Strong pieces (>9): 2
    → Has RED_GENERAL: False
✅ SUCCESS: No weak hands - redeal prevented!
✅ PREP_STATE_DEBUG: No weak hands - keeping existing starter: Andy
📢 DECL_STATE_DEBUG: Using round_starter: Andy
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔄 PHASE_TRACKING_FIX: New phase detected preparation -> declaration
🚀 ENTERPRISE_BOT_DEBUG: _handle_enterprise_phase_change called - phase: declaration
👤 ENTERPRISE_BOT_DEBUG: Current declarer Andy is human - waiting
DEBUG_WS: Message for event 'phase_change' added to queue for room 070A0B.
🔍 BOT_ROUND_DEBUG: Game state current_order: None
🔍 BOT_ROUND_DEBUG: Game round_starter: Andy
🔍 BOT_ROUND_DEBUG: Game current_player: Andy
👤 Round starter is human or None: None
🔍 DECL_PHASE_DEBUG: _handle_declaration_phase called with last_declarer: ''
🔍 BOT_DEBUG: Got declaration order from state machine: ['Andy', 'Bot 2', 'Bot 3', 'Bot 4']
🔍 DECL_PHASE_DEBUG: Declaration order: ['Andy', 'Bot 2', 'Bot 3', 'Bot 4']
🔍 DECL_PHASE_DEBUG: Last declarer '' index: -1
🔍 DECL_PHASE_DEBUG: Starting loop from index 0 to 4
🔍 DECL_PHASE_DEBUG: Checking player 0 (Andy), is_bot: False
🔍 DECL_PHASE_DEBUG: Player Andy is human, stopping bot declarations
DEBUG_WS_RECEIVE: Received event 'ping' from client in room lobby with data: {'timestamp': 1751988819316}
DEBUG_WS_RECEIVE: Received event 'ping' from client in room 070A0B with data: {'timestamp': 1751988822271}